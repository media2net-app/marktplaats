"use strict";(()=>{var e={};e.id=804,e.ids=[804],e.modules={53524:e=>{e.exports=require("@prisma/client")},41506:e=>{e.exports=require("@prisma/client/edge")},72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},86624:e=>{e.exports=require("querystring")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},45986:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>M,requestAsyncStorage:()=>w,routeModule:()=>x,serverHooks:()=>U,staticGenerationAsyncStorage:()=>N});var s={};r.r(s),r.d(s,{POST:()=>h});var a=r(49303),i=r(88716),o=r(60670),n=r(87070),l=r(90455),p=r(72331),u=r(61282),d=r(21764),c=r(55315),m=r.n(c),f=r(92048),g=r.n(f);let j=(0,d.promisify)(u.exec);async function h(e){try{let t=await (0,l.Z)();if(!t||!t.user)return n.NextResponse.json({error:"Unauthorized"},{status:401});let r=(await e.json().catch(()=>({}))).userUrl||"https://www.marktplaats.nl/u/chiel/23777446/",s=await p._.product.findMany({where:{userId:t.user.id,status:"completed",marktplaatsUrl:{not:null}}});if(0===s.length)return n.NextResponse.json({message:"No completed products found",updated:0});let a=process.cwd(),i=m().join(a,"scripts","scrape_user_ads.py"),o=process.env.PYTHON_CMD||"python";if(!g().existsSync(i))return n.NextResponse.json({error:`Script not found at ${i}`},{status:500});let{stdout:u,stderr:d}=await j(`"${o}" "${i}" --url "${r}"`,{cwd:a,maxBuffer:10485760,timeout:12e4,env:{...process.env,PYTHONUNBUFFERED:"1"}}),c=u+d,f=c.match(/USER_ADS_JSON:(\[.+?\])/s);if(!f)return n.NextResponse.json({error:"Could not parse ads from script output",output:c},{status:500});let h=JSON.parse(f[1]),x=0;for(let e of s){let t=h.find(t=>{let r=e.marktplaatsAdId;if(r&&t.ad_id&&t.ad_id===r)return!0;if(e.marktplaatsUrl&&t.ad_url){let r=e.marktplaatsUrl.replace(/\/$/,""),s=t.ad_url.replace(/\/$/,"");if(r===s||r.includes(s)||s.includes(r))return!0}if(e.title&&t.title){let r=e.title.toLowerCase().trim(),s=t.title.toLowerCase().trim();if(r===s||r.includes(s)||s.includes(r))return!0}return!!(e.articleNumber&&t.title&&t.title.includes(e.articleNumber))});if(t){let r=null;if(t.posted_at){let e=t.posted_at;if("Vandaag"===e)r=new Date;else if("Gisteren"===e){let e=new Date;e.setDate(e.getDate()-1),r=e}else e.startsWith("Sinds"),r=new Date}let s={views:t.views||0,saves:t.saves||0};t.ad_id&&(s.marktplaatsAdId=t.ad_id),t.ad_url&&(s.marktplaatsUrl=t.ad_url),r&&(s.postedAt=r),await p._.product.update({where:{id:e.id},data:s}),x++,console.log(`Updated product ${e.id}: views=${s.views}, saves=${s.saves}`)}else console.log(`No matching ad found for product ${e.id} (${e.title})`)}return n.NextResponse.json({success:!0,message:`Updated ${x} of ${s.length} products`,updated:x,total:s.length})}catch(e){return console.error("Error syncing stats:",e),n.NextResponse.json({error:e.message||"Internal server error",details:e.stderr||e.stdout},{status:500})}}let x=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/products/sync-stats/route",pathname:"/api/products/sync-stats",filename:"route",bundlePath:"app/api/products/sync-stats/route"},resolvedPagePath:"/Users/gebruiker/Desktop/marktplaats/app/api/products/sync-stats/route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:w,staticGenerationAsyncStorage:N,serverHooks:U}=x,y="/api/products/sync-stats/route";function M(){return(0,o.patchFetch)({serverHooks:U,staticGenerationAsyncStorage:N})}},90455:(e,t,r)=>{r.d(t,{L:()=>o,Z:()=>n});var s=r(53797),a=r(42023),i=r(72331);let o={secret:process.env.NEXTAUTH_SECRET||"fallback-secret-change-in-production",providers:[(0,s.Z)({name:"Credentials",credentials:{email:{label:"Email",type:"email"},password:{label:"Password",type:"password"}},async authorize(e){try{if(!e?.email||!e?.password)return console.log("[AUTH] Missing credentials"),null;console.log("[AUTH] Attempting login for:",e.email);let t=await i._.user.findUnique({where:{email:e.email}});if(!t)return console.log("[AUTH] User not found:",e.email),null;if(!t.password)return console.log("[AUTH] User has no password"),null;if(console.log("[AUTH] Comparing password..."),!await (0,a.compare)(e.password,t.password))return console.log("[AUTH] Invalid password for:",e.email),null;return console.log("[AUTH] Login successful for:",e.email),{id:t.id,email:t.email,name:t.name}}catch(e){return console.error("[AUTH] Error:",e),console.error("[AUTH] Error details:",e?.message,e?.stack),null}}})],session:{strategy:"jwt"},pages:{signIn:"/login"},callbacks:{jwt:async({token:e,user:t})=>(t&&(e.id=t.id),e),session:async({session:e,token:t})=>(e.user&&(e.user.id=t.id),e)}};async function n(){let{getServerSession:e}=await r.e(571).then(r.t.bind(r,75571,23));return await e({...o})}},72331:(e,t,r)=>{r.d(t,{_:()=>i});var s=r(53524),a=r(41506);let i=globalThis.prisma??("prisma+postgres://accelerate.prisma-data.net/?api_key=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqd3RfaWQiOjEsInNlY3VyZV9rZXkiOiJza19MUFdDSjREMDBhMU9PZDNuNjdfYU0iLCJhcGlfa2V5IjoiMDFLQkNERldLQ1dDVjM0RDlHR0pOQUZFTVoiLCJ0ZW5hbnRfaWQiOiJkZGM1ODVhODNmYjUzYjFlMzg3MmU4OGI2ZTMyOGRhNzI1NzlkMDM3ZGFiNGEwNTNiNWM3MGFjNDZlMDk0YzJjIiwiaW50ZXJuYWxfc2VjcmV0IjoiNDc2ZGVlZjAtN2YxYy00OWYzLThkYmMtYjE3MjdjOWQyZjk4In0.ojkrzU8cUtog61nW8bPeJZYiRekMsIMEje5MmqXxyvg".startsWith("prisma+postgres://")?new a.PrismaClient({datasourceUrl:"prisma+postgres://accelerate.prisma-data.net/?api_key=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqd3RfaWQiOjEsInNlY3VyZV9rZXkiOiJza19MUFdDSjREMDBhMU9PZDNuNjdfYU0iLCJhcGlfa2V5IjoiMDFLQkNERldLQ1dDVjM0RDlHR0pOQUZFTVoiLCJ0ZW5hbnRfaWQiOiJkZGM1ODVhODNmYjUzYjFlMzg3MmU4OGI2ZTMyOGRhNzI1NzlkMDM3ZGFiNGEwNTNiNWM3MGFjNDZlMDk0YzJjIiwiaW50ZXJuYWxfc2VjcmV0IjoiNDc2ZGVlZjAtN2YxYy00OWYzLThkYmMtYjE3MjdjOWQyZjk4In0.ojkrzU8cUtog61nW8bPeJZYiRekMsIMEje5MmqXxyvg"}):new s.PrismaClient({log:["error"]}))}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[276,892,972],()=>r(45986));module.exports=s})();